<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡ç®¡ç† - å•†æˆ·ç®¡ç†åå°</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* ç¡®ä¿å¼¹çª—å¯è§ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        .status.active { color: green; }
        .status.pending { color: orange; }
        .status.rejected { color: red; }
    </style>
</head>
<body>
<header>
    <div class="header-title">å•†æˆ·ç®¡ç†åå°</div>
    <nav>
        <span class="user-icon">ğŸ‘¤</span>
        <a href="#" class="logout-link">é€€å‡ºç™»å½•</a>
    </nav>
</header>

<div class="container">
    <div id="sidebar-container"></div>

    <div class="main">
        <h2>æœåŠ¡ç®¡ç†</h2>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="filter-section">
            <div class="filter-group">
                <label>æœåŠ¡åç§°</label>
                <input type="text" id="filterName" placeholder="è¾“å…¥æœåŠ¡åç§°">
            </div>
            <div class="filter-group">
                <label>æœåŠ¡ç±»å‹</label>
                <input type="text" id="filterType" placeholder="è¾“å…¥æœåŠ¡ç±»å‹">
            </div>
            <div class="filter-group">
                <label>æœåŠ¡å•†å“</label>
                <input type="text" id="filterProduct" placeholder="å•†å“åç§°/ç¼–å·">
            </div>
            <div class="filter-group">
                <label>æœåŠ¡åŒºåŸŸ</label>
                <input type="text" id="filterArea" placeholder="è¾“å…¥æœåŠ¡åŒºåŸŸ">
            </div>
            <div class="filter-group">
                <label>çŠ¶æ€</label>
                <select id="filterStatus">
                    <option value="">å…¨éƒ¨</option>
                    <option value="å¯ç”¨">å¯ç”¨</option>
                    <option value="ç¦ç”¨">ç¦ç”¨</option>
                    <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-search" onclick="applyFilter()">æŸ¥è¯¢</button>
                <button class="btn btn-back" onclick="resetFilter()">é‡ç½®</button>
            </div>
        </div>

        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <button class="btn btn-add" onclick="openAddModal()">+ æ–°å¢æœåŠ¡</button>
            <button class="btn btn-back" onclick="exportServices()">å¯¼å‡ºæ•°æ®</button>
        </div>

        <table class="data-table" id="serviceTable">
            <thead>
                <tr>
                    <th>æœåŠ¡åç§°</th>
                    <th>æœåŠ¡ç±»å‹</th>
                    <th>é€‚ç”¨å•†å“</th>
                    <th>çŠ¶æ€</th>
                    <th>æœåŠ¡åœ°åŒº</th>
                    <th>æœåŠ¡æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pager" id="pagerArea" style="display: none; margin-top: 20px; justify-content: flex-end; gap: 10px;">
            <span id="pagerInfo">å…± 0 æ¡</span>
            <button class="btn btn-back" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
            <button class="btn btn-back" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>
</div>

<!-- æ–°å¢æœåŠ¡å¼¹çª— -->
<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <h3>æ–°å¢å•†å“æœåŠ¡</h3>
        <form id="addServiceForm" class="form-container" onsubmit="return handleAddService(event)">
            <div class="form-group">
                <label>æœåŠ¡åç§° *</label>
                <input type="text" id="add_name" required placeholder="è¯·è¾“å…¥æœåŠ¡åç§°">
            </div>
            <div class="form-group">
                <label>æœåŠ¡ç±»å‹ *</label>
                <input type="text" id="add_type" required placeholder="å¦‚ï¼šå®‰è£…ã€ç»´ä¿®ã€æ¸…æ´—">
            </div>
            <div class="form-group">
                <label>æœåŠ¡æ—¶é—´ *</label>
                <input type="text" id="add_time" required placeholder="å¦‚ï¼š9:00-18:00">
            </div>
            <div class="form-group">
                <label>æœåŠ¡åœ°åŒº *</label>
                <input type="text" id="add_area" required placeholder="å¦‚ï¼šä¸Šæµ·ã€åä¸œåœ°åŒº">
            </div>
            <div class="form-group">
                <label>é€‚ç”¨å•†å“ *</label>
                <input type="text" id="add_products" required placeholder="å¤šä¸ªå•†å“ç”¨é€—å·åˆ†éš”">
            </div>
            <div class="form-actions">
                <button class="btn btn-submit" type="submit">æäº¤æ–°å¢</button>
                <button class="btn btn-cancel" type="button" onclick="closeAddModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<!-- ä¿®æ”¹æœåŠ¡å¼¹çª— -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <h3>ä¿®æ”¹æœåŠ¡ä¿¡æ¯</h3>
        <form id="editServiceForm" class="form-container" onsubmit="return handleEditService(event)">
            <input type="hidden" id="edit_index">
            <div class="form-group">
                <label>æœåŠ¡åç§° *</label>
                <input type="text" id="edit_name" required>
            </div>
            <div class="form-group">
                <label>æœåŠ¡çŠ¶æ€</label>
                <select id="edit_status">
                    <option value="å¯ç”¨">å¯ç”¨</option>
                    <option value="ç¦ç”¨">ç¦ç”¨</option>
                    <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                </select>
            </div>
            <div class="form-group">
                <label>æœåŠ¡ç±»å‹ *</label>
                <input type="text" id="edit_type" required>
            </div>
            <div class="form-group">
                <label>æœåŠ¡æ—¶é—´ *</label>
                <input type="text" id="edit_time" required>
            </div>
            <div class="form-group">
                <label>æœåŠ¡åœ°åŒº *</label>
                <input type="text" id="edit_area" required>
            </div>
            <div class="form-group">
                <label>é€‚ç”¨å•†å“ *</label>
                <input type="text" id="edit_products" required>
            </div>
            <div class="form-actions">
                <button class="btn btn-submit" type="submit">ä¿å­˜ä¿®æ”¹</button>
                <button class="btn btn-cancel" type="button" onclick="closeEditModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<script>
    /*************************************************************************
     * æ•°æ®ä¸çŠ¶æ€
     *************************************************************************/
    const availableProducts = ['TV-001', 'REF-100', 'AC-200', 'WASH-10', 'TV-002', 'å†°ç®±123', 'æ™ºèƒ½éŸ³ç®±88'];
    let services = [
        { name: 'ä¸Šé—¨å®‰è£…', type: 'å®‰è£…', products: ['TV-001','TV-002'], status:'å¯ç”¨', area:'åä¸œåœ°åŒº', time:'9:00-18:00' },
        { name: 'å®¶ç”µç»´ä¿®', type: 'ç»´ä¿®', products: ['REF-100','WASH-10'], status:'å¯ç”¨', area:'ä¸Šæµ·', time:'08:00-20:00' },
        { name: 'æ¸…æ´—ä¿å…»', type: 'ä¿å…»', products: ['AC-200'], status:'ç¦ç”¨', area:'åŒ—äº¬', time:'10:00-17:00' }
    ];
    let filteredServices = [...services];
    let page = 1, pageSize = 10;

    /*************************************************************************
     * æ¸²æŸ“è¡¨æ ¼
     *************************************************************************/
    function renderTable() {
        const tbody = document.querySelector('#serviceTable tbody');
        tbody.innerHTML = '';
        const start = (page-1)*pageSize;
        const slice = filteredServices.slice(start, start+pageSize);

        slice.forEach((s, idx)=>{
            const realIndex = services.indexOf(s);
            let statusClass = 'status active';
            if(s.status==='ç¦ç”¨') statusClass='status pending';
            if(s.status==='å·²å–æ¶ˆ') statusClass='status rejected';
            const tr = document.createElement('tr');
            tr.innerHTML=`
                <td>${escapeHtml(s.name)}</td>
                <td>${escapeHtml(s.type)}</td>
                <td>${escapeHtml(s.products.join(', '))}</td>
                <td><span class="${statusClass}">${escapeHtml(s.status)}</span></td>
                <td>${escapeHtml(s.area)}</td>
                <td>${escapeHtml(s.time)}</td>
                <td>
                    <button class="btn btn-edit" onclick="openEditModal(${realIndex})">ä¿®æ”¹</button>
                    <button class="btn btn-delete" onclick="cancelService(${realIndex})">å–æ¶ˆæœåŠ¡</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('pagerInfo').innerText = `å…± ${filteredServices.length} æ¡`;
        document.getElementById('pagerArea').style.display = filteredServices.length>pageSize?'flex':'none';
    }

    function escapeHtml(str){
        if(typeof str!=='string') return str;
        return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /*************************************************************************
     * æŸ¥è¯¢/è¿‡æ»¤
     *************************************************************************/
    function applyFilter() {
        const name=document.getElementById('filterName').value.trim().toLowerCase();
        const type=document.getElementById('filterType').value.trim().toLowerCase();
        const product=document.getElementById('filterProduct').value.trim().toLowerCase();
        const area=document.getElementById('filterArea').value.trim().toLowerCase();
        const status=document.getElementById('filterStatus').value;

        filteredServices = services.filter(s=>{
            if(name&&!s.name.toLowerCase().includes(name)) return false;
            if(type&&!s.type.toLowerCase().includes(type)) return false;
            if(product&&!s.products.join(',').toLowerCase().includes(product)) return false;
            if(area&&!s.area.toLowerCase().includes(area)) return false;
            if(status&&s.status!==status) return false;
            return true;
        });
        page=1;
        renderTable();
        if(filteredServices.length===0) alert('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æœåŠ¡');
    }

    function resetFilter(){
        document.getElementById('filterName').value='';
        document.getElementById('filterType').value='';
        document.getElementById('filterProduct').value='';
        document.getElementById('filterArea').value='';
        document.getElementById('filterStatus').value='';
        filteredServices=[...services];
        page=1;
        renderTable();
    }

    /*************************************************************************
     * æ–°å¢æœåŠ¡
     *************************************************************************/
    function openAddModal() {
        document.getElementById('addModal').style.display='flex';
        document.getElementById('addServiceForm').reset();
    }
    function closeAddModal() {
        document.getElementById('addModal').style.display='none';
        document.getElementById('addServiceForm').reset();
    }
    function handleAddService(e){
        e.preventDefault();
        const name=document.getElementById('add_name').value.trim();
        const type=document.getElementById('add_type').value.trim();
        const timeVal=document.getElementById('add_time').value.trim();
        const area=document.getElementById('add_area').value.trim();
        const productsRaw=document.getElementById('add_products').value.trim();

        if(!name||!type||!timeVal||!area||!productsRaw){ alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ'); return false; }

        const products = productsRaw.split(',').map(s=>s.trim()).filter(Boolean);
        if(products.length===0){ alert('å¿…é¡»é€‰æ‹©è‡³å°‘ä¸€ä¸ªé€‚ç”¨çš„å•†å“'); return false; }

        const missing = products.filter(p=>!availableProducts.includes(p));
        if(missing.length>0){ alert('ä»¥ä¸‹å•†å“ä¸å­˜åœ¨æˆ–ä¸å¯ç”¨ï¼š'+missing.join(', ')); return false; }

        services.unshift({name,type,time:timeVal,area,products,status:'å¯ç”¨'});
        closeAddModal();
        filteredServices=[...services];
        renderTable();
        alert('æœåŠ¡å·²æˆåŠŸæ–°å¢ï¼');
        return false;
    }

    /*************************************************************************
     * ä¿®æ”¹æœåŠ¡
     *************************************************************************/
    function openEditModal(index){
        const s=services[index];
        if(!s){ alert('æœªæ‰¾åˆ°æœåŠ¡'); return; }
        document.getElementById('edit_index').value=index;
        document.getElementById('edit_name').value=s.name;
        document.getElementById('edit_status').value=s.status;
        document.getElementById('edit_type').value=s.type;
        document.getElementById('edit_time').value=s.time;
        document.getElementById('edit_area').value=s.area;
        document.getElementById('edit_products').value=s.products.join(', ');
        document.getElementById('editModal').style.display='flex';
    }
    function closeEditModal(){ document.getElementById('editModal').style.display='none'; }
    function handleEditService(e){
        e.preventDefault();
        const idx=parseInt(document.getElementById('edit_index').value,10);
        const name=document.getElementById('edit_name').value.trim();
        const status=document.getElementById('edit_status').value;
        const type=document.getElementById('edit_type').value.trim();
        const timeVal=document.getElementById('edit_time').value.trim();
        const area=document.getElementById('edit_area').value.trim();
        const productsRaw=document.getElementById('edit_products').value.trim();

        if(!name||!type||!timeVal||!area||!productsRaw){ alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ'); return false; }
        const products = productsRaw.split(',').map(s=>s.trim()).filter(Boolean);
        const missing = products.filter(p=>!availableProducts.includes(p));
        if(missing.length>0){ alert('ä»¥ä¸‹å•†å“ä¸å­˜åœ¨æˆ–ä¸å¯ç”¨ï¼š'+missing.join(', ')); return false; }

        services[idx]={name,type,time:timeVal,area,products,status};
        closeEditModal();
        filteredServices=[...services];
        renderTable();
        alert('æœåŠ¡ä¿¡æ¯å·²ä¿å­˜');
        return false;
    }

    /*************************************************************************
     * å–æ¶ˆæœåŠ¡
     *************************************************************************/
    function cancelService(index){
        const s=services[index];
        if(!s){ alert('æœªæ‰¾åˆ°æœåŠ¡'); return; }
        if(s.status==='å·²å–æ¶ˆ'){ alert('è¯¥æœåŠ¡å·²æ˜¯å·²å–æ¶ˆçŠ¶æ€'); return; }
        if(!confirm(`ç¡®è®¤è¦å–æ¶ˆæœåŠ¡ã€Œ${s.name}ã€å—ï¼Ÿ`)) return;
        s.status='å·²å–æ¶ˆ';
        filteredServices=[...services];
        renderTable();
        alert('æœåŠ¡å·²å–æ¶ˆ');
    }

    /*************************************************************************
     * å¯¼å‡º
     *************************************************************************/
    function exportServices(){
        if(services.length===0){ alert('æ— æ•°æ®å¯å¯¼å‡º'); return; }
        const rows=[['æœåŠ¡åç§°','æœåŠ¡ç±»å‹','é€‚ç”¨å•†å“','çŠ¶æ€','åœ°åŒº','æ—¶é—´']];
        services.forEach(s=>rows.push([s.name,s.type,s.products.join(';'),s.status,s.area,s.time]));
        const csv=rows.map(r=>r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='services_export_'+Date.now()+'.csv';
        document.body.appendChild(a);
        a.click(); a.remove();
        URL.revokeObjectURL(url);
        alert('å¯¼å‡ºæˆåŠŸï¼');
    }

    /*************************************************************************
     * åˆ†é¡µ
     *************************************************************************/
    function prevPage(){ if(page>1){ page--; renderTable(); } }
    function nextPage(){ const max=Math.ceil(filteredServices.length/pageSize); if(page<max){ page++; renderTable(); } }

    /*************************************************************************
     * åˆå§‹åŒ–
     *************************************************************************/
    document.addEventListener('DOMContentLoaded',()=>{
        renderTable();

        document.getElementById('addModal').addEventListener('click',(e)=>{
            if(e.target===document.getElementById('addModal')) closeAddModal();
        });
        document.getElementById('editModal').addEventListener('click',(e)=>{
            if(e.target===document.getElementById('editModal')) closeEditModal();
        });
    });
</script>
<script src="../script.js"></script>
<script>
    // åŠ¨æ€åŠ è½½ä¾§è¾¹æ ï¼Œä¸æ´»åŠ¨åˆ—è¡¨é¡µä¿æŒä¸€è‡´
    fetch('../sidebar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('sidebar-container').innerHTML = data;

            // æ¿€æ´»å½“å‰èœå•é¡¹ï¼ˆå‡è®¾æœåŠ¡ç®¡ç†çš„èœå•idæ˜¯ serviceMenuï¼‰
            const menuLink = document.querySelector('a[onclick="toggleMenu(\'serviceMenu\')"]');
            if (menuLink) {
                menuLink.classList.add('active');
                toggleMenu('serviceMenu');
            }
        })
        .catch(err => console.error('åŠ è½½ä¾§è¾¹æ å¤±è´¥:', err));
</script>

</body>
</html>
