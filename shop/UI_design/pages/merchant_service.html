<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务管理 - 商户管理后台</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* 确保弹窗可见 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        .status.active { color: green; }
        .status.pending { color: orange; }
        .status.rejected { color: red; }
    </style>
</head>
<body>
<header>
    <div class="header-title">商户管理后台</div>
    <nav>
        <span class="user-icon">👤</span>
        <a href="#" class="logout-link">退出登录</a>
    </nav>
</header>

<div class="container">
    <div id="sidebar-container"></div>

    <div class="main">
        <h2>服务管理</h2>

        <!-- 筛选区域 -->
        <div class="filter-section">
            <div class="filter-group">
                <label>服务名称</label>
                <input type="text" id="filterName" placeholder="输入服务名称">
            </div>
            <div class="filter-group">
                <label>服务类型</label>
                <input type="text" id="filterType" placeholder="输入服务类型">
            </div>
            <div class="filter-group">
                <label>服务商品</label>
                <input type="text" id="filterProduct" placeholder="商品名称/编号">
            </div>
            <div class="filter-group">
                <label>服务区域</label>
                <input type="text" id="filterArea" placeholder="输入服务区域">
            </div>
            <div class="filter-group">
                <label>状态</label>
                <select id="filterStatus">
                    <option value="">全部</option>
                    <option value="启用">启用</option>
                    <option value="禁用">禁用</option>
                    <option value="已取消">已取消</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-search" onclick="applyFilter()">查询</button>
                <button class="btn btn-back" onclick="resetFilter()">重置</button>
            </div>
        </div>

        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <button class="btn btn-add" onclick="openAddModal()">+ 新增服务</button>
            <button class="btn btn-back" onclick="exportServices()">导出数据</button>
        </div>

        <table class="data-table" id="serviceTable">
            <thead>
                <tr>
                    <th>服务名称</th>
                    <th>服务类型</th>
                    <th>适用商品</th>
                    <th>状态</th>
                    <th>服务地区</th>
                    <th>服务时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="pager" id="pagerArea" style="display: none; margin-top: 20px; justify-content: flex-end; gap: 10px;">
            <span id="pagerInfo">共 0 条</span>
            <button class="btn btn-back" onclick="prevPage()">上一页</button>
            <button class="btn btn-back" onclick="nextPage()">下一页</button>
        </div>
    </div>
</div>

<!-- 新增服务弹窗 -->
<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <h3>新增商品服务</h3>
        <form id="addServiceForm" class="form-container" onsubmit="return handleAddService(event)">
            <div class="form-group">
                <label>服务名称 *</label>
                <input type="text" id="add_name" required placeholder="请输入服务名称">
            </div>
            <div class="form-group">
                <label>服务类型 *</label>
                <input type="text" id="add_type" required placeholder="如：安装、维修、清洗">
            </div>
            <div class="form-group">
                <label>服务时间 *</label>
                <input type="text" id="add_time" required placeholder="如：9:00-18:00">
            </div>
            <div class="form-group">
                <label>服务地区 *</label>
                <input type="text" id="add_area" required placeholder="如：上海、华东地区">
            </div>
            <div class="form-group">
                <label>适用商品 *</label>
                <input type="text" id="add_products" required placeholder="多个商品用逗号分隔">
            </div>
            <div class="form-actions">
                <button class="btn btn-submit" type="submit">提交新增</button>
                <button class="btn btn-cancel" type="button" onclick="closeAddModal()">取消</button>
            </div>
        </form>
    </div>
</div>

<!-- 修改服务弹窗 -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <h3>修改服务信息</h3>
        <form id="editServiceForm" class="form-container" onsubmit="return handleEditService(event)">
            <input type="hidden" id="edit_index">
            <div class="form-group">
                <label>服务名称 *</label>
                <input type="text" id="edit_name" required>
            </div>
            <div class="form-group">
                <label>服务状态</label>
                <select id="edit_status">
                    <option value="启用">启用</option>
                    <option value="禁用">禁用</option>
                    <option value="已取消">已取消</option>
                </select>
            </div>
            <div class="form-group">
                <label>服务类型 *</label>
                <input type="text" id="edit_type" required>
            </div>
            <div class="form-group">
                <label>服务时间 *</label>
                <input type="text" id="edit_time" required>
            </div>
            <div class="form-group">
                <label>服务地区 *</label>
                <input type="text" id="edit_area" required>
            </div>
            <div class="form-group">
                <label>适用商品 *</label>
                <input type="text" id="edit_products" required>
            </div>
            <div class="form-actions">
                <button class="btn btn-submit" type="submit">保存修改</button>
                <button class="btn btn-cancel" type="button" onclick="closeEditModal()">取消</button>
            </div>
        </form>
    </div>
</div>

<script>
    /*************************************************************************
     * 数据与状态
     *************************************************************************/
    const availableProducts = ['TV-001', 'REF-100', 'AC-200', 'WASH-10', 'TV-002', '冰箱123', '智能音箱88'];
    let services = [
        { name: '上门安装', type: '安装', products: ['TV-001','TV-002'], status:'启用', area:'华东地区', time:'9:00-18:00' },
        { name: '家电维修', type: '维修', products: ['REF-100','WASH-10'], status:'启用', area:'上海', time:'08:00-20:00' },
        { name: '清洗保养', type: '保养', products: ['AC-200'], status:'禁用', area:'北京', time:'10:00-17:00' }
    ];
    let filteredServices = [...services];
    let page = 1, pageSize = 10;

    /*************************************************************************
     * 渲染表格
     *************************************************************************/
    function renderTable() {
        const tbody = document.querySelector('#serviceTable tbody');
        tbody.innerHTML = '';
        const start = (page-1)*pageSize;
        const slice = filteredServices.slice(start, start+pageSize);

        slice.forEach((s, idx)=>{
            const realIndex = services.indexOf(s);
            let statusClass = 'status active';
            if(s.status==='禁用') statusClass='status pending';
            if(s.status==='已取消') statusClass='status rejected';
            const tr = document.createElement('tr');
            tr.innerHTML=`
                <td>${escapeHtml(s.name)}</td>
                <td>${escapeHtml(s.type)}</td>
                <td>${escapeHtml(s.products.join(', '))}</td>
                <td><span class="${statusClass}">${escapeHtml(s.status)}</span></td>
                <td>${escapeHtml(s.area)}</td>
                <td>${escapeHtml(s.time)}</td>
                <td>
                    <button class="btn btn-edit" onclick="openEditModal(${realIndex})">修改</button>
                    <button class="btn btn-delete" onclick="cancelService(${realIndex})">取消服务</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('pagerInfo').innerText = `共 ${filteredServices.length} 条`;
        document.getElementById('pagerArea').style.display = filteredServices.length>pageSize?'flex':'none';
    }

    function escapeHtml(str){
        if(typeof str!=='string') return str;
        return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /*************************************************************************
     * 查询/过滤
     *************************************************************************/
    function applyFilter() {
        const name=document.getElementById('filterName').value.trim().toLowerCase();
        const type=document.getElementById('filterType').value.trim().toLowerCase();
        const product=document.getElementById('filterProduct').value.trim().toLowerCase();
        const area=document.getElementById('filterArea').value.trim().toLowerCase();
        const status=document.getElementById('filterStatus').value;

        filteredServices = services.filter(s=>{
            if(name&&!s.name.toLowerCase().includes(name)) return false;
            if(type&&!s.type.toLowerCase().includes(type)) return false;
            if(product&&!s.products.join(',').toLowerCase().includes(product)) return false;
            if(area&&!s.area.toLowerCase().includes(area)) return false;
            if(status&&s.status!==status) return false;
            return true;
        });
        page=1;
        renderTable();
        if(filteredServices.length===0) alert('未找到符合条件的服务');
    }

    function resetFilter(){
        document.getElementById('filterName').value='';
        document.getElementById('filterType').value='';
        document.getElementById('filterProduct').value='';
        document.getElementById('filterArea').value='';
        document.getElementById('filterStatus').value='';
        filteredServices=[...services];
        page=1;
        renderTable();
    }

    /*************************************************************************
     * 新增服务
     *************************************************************************/
    function openAddModal() {
        document.getElementById('addModal').style.display='flex';
        document.getElementById('addServiceForm').reset();
    }
    function closeAddModal() {
        document.getElementById('addModal').style.display='none';
        document.getElementById('addServiceForm').reset();
    }
    function handleAddService(e){
        e.preventDefault();
        const name=document.getElementById('add_name').value.trim();
        const type=document.getElementById('add_type').value.trim();
        const timeVal=document.getElementById('add_time').value.trim();
        const area=document.getElementById('add_area').value.trim();
        const productsRaw=document.getElementById('add_products').value.trim();

        if(!name||!type||!timeVal||!area||!productsRaw){ alert('请填写所有必填字段'); return false; }

        const products = productsRaw.split(',').map(s=>s.trim()).filter(Boolean);
        if(products.length===0){ alert('必须选择至少一个适用的商品'); return false; }

        const missing = products.filter(p=>!availableProducts.includes(p));
        if(missing.length>0){ alert('以下商品不存在或不可用：'+missing.join(', ')); return false; }

        services.unshift({name,type,time:timeVal,area,products,status:'启用'});
        closeAddModal();
        filteredServices=[...services];
        renderTable();
        alert('服务已成功新增！');
        return false;
    }

    /*************************************************************************
     * 修改服务
     *************************************************************************/
    function openEditModal(index){
        const s=services[index];
        if(!s){ alert('未找到服务'); return; }
        document.getElementById('edit_index').value=index;
        document.getElementById('edit_name').value=s.name;
        document.getElementById('edit_status').value=s.status;
        document.getElementById('edit_type').value=s.type;
        document.getElementById('edit_time').value=s.time;
        document.getElementById('edit_area').value=s.area;
        document.getElementById('edit_products').value=s.products.join(', ');
        document.getElementById('editModal').style.display='flex';
    }
    function closeEditModal(){ document.getElementById('editModal').style.display='none'; }
    function handleEditService(e){
        e.preventDefault();
        const idx=parseInt(document.getElementById('edit_index').value,10);
        const name=document.getElementById('edit_name').value.trim();
        const status=document.getElementById('edit_status').value;
        const type=document.getElementById('edit_type').value.trim();
        const timeVal=document.getElementById('edit_time').value.trim();
        const area=document.getElementById('edit_area').value.trim();
        const productsRaw=document.getElementById('edit_products').value.trim();

        if(!name||!type||!timeVal||!area||!productsRaw){ alert('请填写所有必填字段'); return false; }
        const products = productsRaw.split(',').map(s=>s.trim()).filter(Boolean);
        const missing = products.filter(p=>!availableProducts.includes(p));
        if(missing.length>0){ alert('以下商品不存在或不可用：'+missing.join(', ')); return false; }

        services[idx]={name,type,time:timeVal,area,products,status};
        closeEditModal();
        filteredServices=[...services];
        renderTable();
        alert('服务信息已保存');
        return false;
    }

    /*************************************************************************
     * 取消服务
     *************************************************************************/
    function cancelService(index){
        const s=services[index];
        if(!s){ alert('未找到服务'); return; }
        if(s.status==='已取消'){ alert('该服务已是已取消状态'); return; }
        if(!confirm(`确认要取消服务「${s.name}」吗？`)) return;
        s.status='已取消';
        filteredServices=[...services];
        renderTable();
        alert('服务已取消');
    }

    /*************************************************************************
     * 导出
     *************************************************************************/
    function exportServices(){
        if(services.length===0){ alert('无数据可导出'); return; }
        const rows=[['服务名称','服务类型','适用商品','状态','地区','时间']];
        services.forEach(s=>rows.push([s.name,s.type,s.products.join(';'),s.status,s.area,s.time]));
        const csv=rows.map(r=>r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='services_export_'+Date.now()+'.csv';
        document.body.appendChild(a);
        a.click(); a.remove();
        URL.revokeObjectURL(url);
        alert('导出成功！');
    }

    /*************************************************************************
     * 分页
     *************************************************************************/
    function prevPage(){ if(page>1){ page--; renderTable(); } }
    function nextPage(){ const max=Math.ceil(filteredServices.length/pageSize); if(page<max){ page++; renderTable(); } }

    /*************************************************************************
     * 初始化
     *************************************************************************/
    document.addEventListener('DOMContentLoaded',()=>{
        renderTable();

        document.getElementById('addModal').addEventListener('click',(e)=>{
            if(e.target===document.getElementById('addModal')) closeAddModal();
        });
        document.getElementById('editModal').addEventListener('click',(e)=>{
            if(e.target===document.getElementById('editModal')) closeEditModal();
        });
    });
</script>
<script src="../script.js"></script>
<script>
    // 动态加载侧边栏，与活动列表页保持一致
    fetch('../sidebar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('sidebar-container').innerHTML = data;

            // 激活当前菜单项（假设服务管理的菜单id是 serviceMenu）
            const menuLink = document.querySelector('a[onclick="toggleMenu(\'serviceMenu\')"]');
            if (menuLink) {
                menuLink.classList.add('active');
                toggleMenu('serviceMenu');
            }
        })
        .catch(err => console.error('加载侧边栏失败:', err));
</script>

</body>
</html>
